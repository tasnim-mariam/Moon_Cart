<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            name="description"
            content="Request new products on MoonCart"
        />
        <title>Product Requests - MoonCart</title>
        <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link rel="stylesheet" href="css/main.css" />
        <link rel="stylesheet" href="css/responsive.css" />
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="container">
                <nav class="navbar">
                    <a href="index.html" class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-moon"></i>
                        </div>
                        <div class="logo-text">
                            <span class="logo-main"
                                >Moon<span class="logo-accent">Cart</span></span
                            >
                            <span class="logo-tagline">Fresh & Fast</span>
                        </div>
                    </a>

                    <ul class="nav-menu">
                        <li>
                            <a href="index.html" class="nav-link">
                                <i class="fas fa-home"></i>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="products.html" class="nav-link">
                                <i class="fas fa-utensils"></i>
                                <span>Products</span>
                            </a>
                        </li>
                        <li>
                            <a href="about.html" class="nav-link">
                                <i class="fas fa-info-circle"></i>
                                <span>About</span>
                            </a>
                        </li>
                        <li>
                            <a href="contact.html" class="nav-link">
                                <i class="fas fa-envelope"></i>
                                <span>Contact</span>
                            </a>
                        </li>
                        <li>
                            <a href="product-requests.html" class="nav-link active">
                                <i class="fas fa-comments"></i>
                                <span>Product Requests</span>
                            </a>
                        </li>
                    </ul>

                    <div class="nav-actions">
                        <a href="cart.html" class="cart-icon-wrapper">
                            <div class="cart-icon">
                                <i class="fas fa-shopping-bag"></i>
                                <span class="cart-count">0</span>
                            </div>
                            <span class="cart-text">Cart</span>
                        </a>
                        <!-- Account Section (Dynamic) -->
                        <div id="account-section" class="account-section">
                            <div class="auth-buttons">
                                <a href="login.html" class="btn-login">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>Login</span>
                                </a>
                                <a href="signup.html" class="btn-signup">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Sign Up</span>
                                </a>
                            </div>
                        </div>

                        <div class="menu-toggle">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <main style="margin-top: 120px; padding: 40px 20px">
            <div class="container">
                <section
                    style="
                        background: white;
                        border-radius: 30px;
                        padding: 40px;
                        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.05);
                        margin-bottom: 30px;
                        text-align: center;
                    "
                >
                    <span
                        style="
                            text-transform: uppercase;
                            font-size: 13px;
                            font-weight: 600;
                            letter-spacing: 2px;
                            color: var(--primary-color);
                        "
                        >MoonCart Requests</span
                    >
                    <h1 style="margin: 15px 0; font-size: 36px">
                        Help us stock what you love
                    </h1>
                    <p style="color: var(--text-light); font-size: 18px">
                        Submit product ideas and track your previous requests all
                        in one place.
                    </p>
                </section>

                <section
                    style="
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 30px;
                    "
                >
                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                        "
                    >
                        <h2 style="margin-bottom: 20px">
                            <i
                                class="fas fa-plus-circle"
                                style="color: var(--primary-color); margin-right: 8px"
                            ></i>
                            Request a Product
                        </h2>
                        <form id="product-request-form">
                            <div class="form-group">
                                <label class="form-label">Product Name *</label>
                                <input
                                    type="text"
                                    id="request-product-name"
                                    class="form-input"
                                    placeholder="What should we add next?"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Category *</label>
                                <select id="request-category" class="form-select" required>
                                    <option value="">Select category</option>
                                    <option value="food">Food</option>
                                    <option value="grocery">Grocery</option>
                                    <option value="medicine">Medicine</option>
                                    <option value="beverages">Beverages</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Your Email *</label>
                                <input
                                    type="email"
                                    id="request-email"
                                    class="form-input"
                                    placeholder="your@email.com"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Description/Details</label>
                                <textarea
                                    id="request-description"
                                    class="form-textarea"
                                    placeholder="Tell us why you'd love to see this product..."
                                    rows="4"
                                ></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-paper-plane"></i> Submit Request
                            </button>
                        </form>
                    </div>

                    <div
                        style="
                            background: white;
                            padding: 30px;
                            border-radius: var(--border-radius);
                            box-shadow: var(--shadow);
                            overflow-x: auto;
                        "
                    >
                        <h2 style="margin-bottom: 20px">
                            <i
                                class="fas fa-list"
                                style="color: var(--primary-color); margin-right: 8px"
                            ></i>
                            My Requests
                        </h2>

                        <div id="my-requests-container">
                            <!-- Requests will be loaded here -->
                            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                <p style="margin-top: 10px;">Loading requests...</p>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>

        <script src="js/main.js"></script>
        <script src="js/api.js"></script>
        <script>
            // Get current user
            const currentUser = MoonCart.getCurrentUser();

            // Pre-fill email if logged in
            document.addEventListener('DOMContentLoaded', function() {
                if (currentUser && currentUser.email) {
                    document.getElementById('request-email').value = currentUser.email;
                }
                
                // Load requests
                loadMyRequests();
            });

            // Handle form submission
            document.getElementById('product-request-form').addEventListener('submit', async function(e) {
                e.preventDefault();

                const productName = document.getElementById('request-product-name').value.trim();
                const category = document.getElementById('request-category').value;
                const email = document.getElementById('request-email').value.trim();
                const description = document.getElementById('request-description').value.trim();

                if (!productName) {
                    MoonCart.showNotification('Please enter a product name', 'error');
                    return;
                }

                if (!category) {
                    MoonCart.showNotification('Please select a category', 'error');
                    return;
                }

                if (!email) {
                    MoonCart.showNotification('Please enter your email', 'error');
                    return;
                }

                MoonCart.showLoading();

                const requestData = {
                    product_name: productName,
                    category: category,
                    email: email,
                    description: description,
                    user_id: currentUser ? currentUser.id : null
                };

                try {
                    const response = await MoonCartAPI.submitProductRequest(requestData);
                    MoonCart.hideLoading();

                    if (response.success) {
                        MoonCart.showNotification('Product request submitted successfully! We\'ll review it soon.', 'success');
                        
                        // Clear form
                        document.getElementById('request-product-name').value = '';
                        document.getElementById('request-category').value = '';
                        document.getElementById('request-description').value = '';
                        
                        // Reload requests
                        loadMyRequests();
                    } else {
                        MoonCart.showNotification(response.message || 'Failed to submit request', 'error');
                    }
                } catch (error) {
                    MoonCart.hideLoading();
                    console.error('Request error:', error);
                    MoonCart.showNotification(error.message || 'Failed to submit request. Please try again.', 'error');
                }
            });

            // Load user's requests
            async function loadMyRequests() {
                const container = document.getElementById('my-requests-container');
                
                if (!currentUser) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-light);">
                            <i class="fas fa-sign-in-alt" style="font-size: 40px; margin-bottom: 15px; color: var(--primary-color);"></i>
                            <p>Please <a href="login.html" style="color: var(--primary-color); font-weight: 600;">login</a> to see your requests</p>
                        </div>
                    `;
                    return;
                }

                try {
                    const response = await MoonCartAPI.getUserProductRequests(currentUser.id);
                    
                    if (response.success && response.requests && response.requests.length > 0) {
                        container.innerHTML = `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${response.requests.map(req => `
                                        <tr>
                                            <td>${formatDate(req.created_at)}</td>
                                            <td>${escapeHtml(req.product_name)}</td>
                                            <td style="text-transform: capitalize;">${escapeHtml(req.category || 'N/A')}</td>
                                            <td>
                                                <span class="status-badge status-${getStatusClass(req.status)}">
                                                    ${formatStatus(req.status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 30px; color: var(--text-light);">
                                <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p>You haven't submitted any requests yet.</p>
                                <p style="font-size: 14px;">Use the form to request a product!</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading requests:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--text-light);">
                            <i class="fas fa-exclamation-circle" style="font-size: 40px; margin-bottom: 15px; color: var(--danger-color);"></i>
                            <p>Failed to load requests.</p>
                            <button class="btn btn-sm" onclick="loadMyRequests()">Try Again</button>
                        </div>
                    `;
                }
            }


            // Helper functions
            function formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            function formatStatus(status) {
                const statusMap = {
                    'pending': 'Pending',
                    'under_review': 'Under Review',
                    'approved': 'Approved',
                    'rejected': 'Rejected'
                };
                return statusMap[status] || status;
            }

            function getStatusClass(status) {
                const classMap = {
                    'pending': 'pending',
                    'under_review': 'pending',
                    'approved': 'confirmed',
                    'rejected': 'cancelled'
                };
                return classMap[status] || 'pending';
            }

            function getStatusColor(status) {
                const colorMap = {
                    'pending': '#ffc107',
                    'under_review': '#17a2b8',
                    'approved': '#28a745',
                    'rejected': '#dc3545'
                };
                return colorMap[status] || '#6c757d';
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </body>
</html>

